<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>forked: WebGL拡張 + Instancing - js do it</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />

<link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />
</head>
<body>
<!-- generated by: jsdo.it - http://jsdo.it/cx20/6Kfq -->
<!-- Copyright cx20 - http://jsdo.it/cx20 -->
<!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->
<script>
/*
  @licstart  The following is the entire license notice for the
  JavaScript and html code in this page.

  Copyright (C) 2015 by Sascha Willems (www.saschawillems.de)

  Source can be found at https://github.com/SaschaWillems

  The JavaScript code in this page is free software: you can
  redistribute it and/or modify it under the terms of the GNU
  General Public License (GNU GPL) as published by the Free Software
  Foundation, either version 3 of the License, or (at your option)
  any later version.  The code is distributed WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS
  FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

  @licend  The above is the entire license notice
  for the JavaScript code in this page.
*/
</script>

<canvas id="rendercanvas" style='position: absolute; left: 0px; top: 0px;' ></canvas>
<div id="hud" ng-controller="hudController">
    <div id="fps" style='position: absolute; left: 5px; top: 5px;'><font color="white">{{ fps }}</font></div>
</div>

<!-- gl-Matrix-min.js -->
<!-- <script src="http://jsrun.it/assets/e/4/3/V/e43V8"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix.js"></script>
<!-- angular.min.js -->
<!-- <script src="http://jsrun.it/assets/h/7/1/t/h71tq"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.26/angular.min.js"></script>
<!-- webglutils.js -->
<!-- <script src="http://jsrun.it/assets/2/f/q/R/2fqRL"></script> -->
<script src="webglutils.js"></script>
<!-- instancing.js -->
<!-- <script src="http://jsrun.it/assets/t/R/z/D/tRzDD"></script> -->
<script src="instancing.js"></script>

<!-- Globe shaders -->
<script id="shader-globe-fs" type="x-shader/x-fragment">
    // Based on a render monkey (ATI, no longer available) shader and tweaked for Projekt "W"
    precision mediump float;

    uniform sampler2D uColorMapDay, uColorMapNight;

    varying float vDiffuse;
    varying vec3 vSpecular;
    varying vec2 vTexCoord;
    varying vec4 vColor;

    const float Terminator = 0.3;
    const float InvTerminator = 1.0 / (2.0 * Terminator);

    void main (void)
    {
        float gloss  = 1.0-texture2D(uColorMapNight, vec2(vTexCoord.s, vTexCoord.t)).g;
        vec3 daytime = texture2D(uColorMapDay, vTexCoord).rgb * vDiffuse + vSpecular * gloss;
        vec3 nighttime = texture2D(uColorMapNight, vTexCoord).rgb;
        vec3 color = daytime;
        if (vDiffuse < -Terminator) {
            color = nighttime;
        }
        if (abs(vDiffuse) < Terminator ) {
            color = mix(nighttime, daytime, (vDiffuse + Terminator) * InvTerminator);
        }
        gl_FragColor = vec4(color * vColor.rgb, 1.0);
    }
</script>

<script id="shader-globe-vs" type="x-shader/x-vertex">
    attribute vec4 aVertexPosition;
    attribute vec3 aNormal;
    attribute vec2 aTextureCoord;
    attribute vec3 aInstancedOffset;
    attribute vec4 aInstancedColor;

    uniform float cos_time_0_2PI;
    uniform float sin_time_0_2PI;
    uniform mat4 uPMatrix;
    uniform mat4 uMVMatrix;
    uniform mat3 uNormalMatrix;
    uniform float season;

    varying float vDiffuse;
    varying vec3 vSpecular;
    varying vec2 vTexCoord;
    varying vec4 vColor;

    void main(void)
    {
        vec4 vertexPos = aVertexPosition;
        vertexPos.xyz += aInstancedOffset;
        vec4 ecPosition = uMVMatrix * vertexPos;
        vec3 normal = normalize(uNormalMatrix * aNormal);
        vec3 lightVec = normalize(uNormalMatrix * vec3(cos_time_0_2PI, season, sin_time_0_2PI));
        vec3 reflectVec = reflect(-lightVec, normal);
        vec3 viewVec = normalize(vec3 (-ecPosition));

        float specIntensity = pow(max(dot(reflectVec, viewVec), 0.0), 8.0);
        vSpecular = (specIntensity * 0.3) * vec3 (1.0, 0.941, 0.898);
        vDiffuse = dot(lightVec, normal);

        vColor = aInstancedColor;

        vTexCoord = aTextureCoord;
        gl_Position = uPMatrix * uMVMatrix * vertexPos;
    }
</script>


<script type="text/javascript" src="index.js"></script>
</body>
</html>
