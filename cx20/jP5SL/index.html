<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Oimo.js を Web Worker で動かしてみるテスト - js do it</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />

<link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />
</head>
<body>
<!-- generated by: jsdo.it - http://jsdo.it/cx20/jP5SL -->
<!-- Copyright cx20 - http://jsdo.it/cx20 -->
<!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->

<!-- Three.js r89 -->
<script src="https://rawcdn.githack.com/mrdoob/three.js/r89/build/three.min.js"></script>

<!-- Detector.js -->
<script type="text/javascript" src="../../assets/s/w/x/5/swx5a.js"></script>

<!-- Three.js -->
<!-- <script src="/assets/d/R/E/W/dREW5"></script> -->

<!-- Detector.js -->
<!-- <script src="/assets/g/c/n/p/gcnpI"></script> -->

<div id='container'></div>

<!-- Worker script, will be run in separate thread -->
<script id="worker1" type="javascript/worker">
// forked from lo-th's "Oimo.js worker example" http://lo-th.github.io/Oimo.js/test_worker.html
var world;
var fps = 0;
var f = [0,0,0];
var body = [];
self.onmessage = function(e) {

    if (e.data.oimoUrl && !world) {
        // Load cannon.js
        importScripts(e.data.oimoUrl);

        // Init physics
        OIMO.WORLD_SCALE = 1;
        OIMO.INV_SCALE = 1;
        world = new OIMO.World(e.data.dt, 2, 8, true);
        world.gravity.init(0,-10,0);

        // Ground plane
        var ground = new OIMO.Body({size:[200, 20, 200], pos:[0,-10,0], world:world});
        
        var N = e.data.N;
        var x, z;
        for(var i=0; i!==N; i++){
            x = -2 + Math.random()*4;
            z = -2 + Math.random()*4;
            if(N < N*0.5) body[i] = new OIMO.Body({type:'sphere', size:[0.25], pos:[x,(0.5*i)+0.5,z], move:true, world:world});
            else  body[i] = new OIMO.Body({type:'box', size:[0.5,0.5,0.5], pos:[x,((0.5*i)+0.5),z], move:true, world:world});
        }
    }

    // Step the world
    world.step();

    // Copy over the data to the buffers
    var matrixs = e.data.matrixs;
    var minfo = e.data.minfo;
    var b = world.rigidBodies;
    var m, j, i=0, n;
    var pos, quad;
    while(b!==null){
        if(b.type === 0x1){
            if(b.sleeeping){
                minfo[n+7] = 1;}
            else{ 
                minfo[n+7] = 0;
                n = 8*i;
                // get position
                pos = b.getPosition();
                minfo[n+0] = pos.x//.toFixed(3)*1;
                minfo[n+1] = pos.y//.toFixed(3)*1;
                minfo[n+2] = pos.z//.toFixed(3)*1;
                // get Quaternion
                quad = b.getQuaternion();
                //if(i==2)console.log(pos.x)
                minfo[n+3] = quad.x//.toFixed(3)*1;
                minfo[n+4] = quad.y//.toFixed(3)*1;
                minfo[n+5] = quad.z//.toFixed(3)*1;
                minfo[n+6] = quad.w//.toFixed(3)*1;
            }

            i++;
        }
        b=b.next;
    }

    f[1] = Date.now();
    if (f[1]-1000>f[0]){ f[0]=f[1]; fps=f[2]; f[2]=0; } f[2]++;
    // Send data back to the main thread
    self.postMessage({ perf:fps, minfo:minfo }, [minfo.buffer]);
};
</script>


<script type="text/javascript" src="index.js"></script>
</body>
</html>
