<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>[WebVR] A-Frame + ShaderMaterial を試してみるテスト（その２） - js do it</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />

<link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />
</head>
<body>
<!-- generated by: jsdo.it - http://jsdo.it/cx20/8EB3 -->
<!-- Copyright cx20 - http://jsdo.it/cx20 -->
<!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->
<!-- aframe.js v0.8.2 -->
<script src="https://unpkg.com/aframe@0.8.2"></script>

<script>
AFRAME.registerShader('my-custom', {
  schema: {
    time: { type: 'time', is: 'uniform' },
  },
  fragmentShader:
`
//precision mediump float;
precision highp float;  // モバイル用GPUだと精度が下がる為、強制的に精度を highp に変更
uniform float time;
varying vec2 vUv;

  #define MAX_ITER 3
  
  vec3 hsv(float h, float s, float v){
    vec4 t = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
    vec3 p = abs(fract(vec3(h) + t.xyz) * 6.0 - vec3(t.w));
    return v * mix(vec3(t.x), clamp(p - vec3(t.x), 0.0, 1.0), s);
  }

void main()
{
    vec4 p = vec4(vUv * 1.0 - 0.5, 0.5, 1.0);
    vec4 r = p - p;
    vec4 q = r;
    float _time = time;
    q.zw -= _time * 0.00005 + 1.0;
    
    for (float i = 1.0; i > 0.; i -= 0.01) {

        float d = 0.0;
        float s = 1.0;

        for (int j = 0; j < 7; j++) {
            r = abs(mod(q * s + 1.0, 2.0) - 1.0);
            r = max(r, r.yzxw);
            d = max(d,(0.3 - length(r * 0.95) * 0.3) / s);
            s *= 3.75;
        }

        q += p * d;
        
        gl_FragColor = p * p + i / 2.0;
        //gl_FragColor = p - p + i / 2.0; // mono color
        gl_FragColor.rgb = hsv(mod(_time/5000.0,1.0), 1.0, 1.0) * 0.3 + gl_FragColor.rgb;

        if(d < 1e-5) break;
    }
    gl_FragColor.a = 1.0;
}
`,
  vertexShader:
`
varying vec2 vUv;

void main()
{
    vUv = uv;
    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
    gl_Position = projectionMatrix * mvPosition;
}
`
});
</script>


<a-scene>
    <a-sky color="#101010"></a-sky>    
    <a-entity position="0 0 3.5">
        <a-camera></a-camera>
    </a-entity>
    <a-entity scale="2 2 2" geometry="primitive: box;" position="0 1 0" material="shader: my-custom;">
        <a-animation easing="linear" attribute="rotation" dur="20000" to="360 360 0" repeat="indefinite"></a-animation>
    </a-entity>
</a-scene>


<script type="text/javascript" src="index.js"></script>
</body>
</html>
