<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Cannon.js を Web Worker で動かしてみるテスト - js do it</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />

<link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />
</head>
<body>
<!-- generated by: jsdo.it - http://jsdo.it/cx20/s73C -->
<!-- Copyright cx20 - http://jsdo.it/cx20 -->
<!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->
<!-- Three.js -->
<!-- <script src="/assets/j/b/l/N/jblNi"></script> -->
<!-- Detector.js -->
<!-- <script src="/assets/K/w/z/X/KwzXG"></script> -->
<!-- TrackballControls.js -->
<!-- <script src="/assets/k/w/x/F/kwxFA"></script> -->

<!-- Three.js r89 -->
<script src="https://rawcdn.githack.com/mrdoob/three.js/r89/build/three.min.js"></script>

<!-- Detector.js -->
<script type="text/javascript" src="../../assets/s/w/x/5/swx5a.js"></script>

<!-- TrackballControls.js -->
<script src="https://rawcdn.githack.com/mrdoob/three.js/r89/examples/js/controls/TrackballControls.js"></script>

<!-- Worker script, will be run in separate thread -->
<script id="worker1" type="javascript/worker">
// forked from schteppe's "cannon.js Web Worker Example" https://github.com/schteppe/cannon.js/blob/master/examples/worker.html
var world;
self.onmessage = function(e) {
    
    if (e.data.cannonUrl && !world) {
        // Load cannon.js
        importScripts(e.data.cannonUrl);
        
        // Init physics
        world = new CANNON.World();
        world.broadphase = new CANNON.NaiveBroadphase();
        world.gravity.set(0,-10,0);
        world.solver.tolerance = 0.001;
        
        // Ground plane
        var plane = new CANNON.Plane();
        var groundBody = new CANNON.Body({ mass: 0 });
        groundBody.addShape(plane);
        groundBody.quaternion.setFromAxisAngle(new CANNON.Vec3(1,0,0),-Math.PI/2);
        world.add(groundBody);
        
        // Create N cubes
        var shape = new CANNON.Box(new CANNON.Vec3(0.5,0.5,0.5));
        for(var i=0; i!==e.data.N; i++){
            var body = new CANNON.Body({ mass: 1 });
            body.addShape(shape);
            body.position.set(Math.random()-0.5,2.5*i+0.5,Math.random()-0.5);
            world.add(body);
        }
    }
    
    // Step the world
    world.step(e.data.dt);
    
    // Copy over the data to the buffers
    var positions = e.data.positions;
    var quaternions = e.data.quaternions;
    for(var i=0; i!==world.bodies.length; i++){
        var b = world.bodies[i],
            p = b.position,
            q = b.quaternion;
        positions[3*i + 0] = p.x;
        positions[3*i + 1] = p.y;
        positions[3*i + 2] = p.z;
        quaternions[4*i + 0] = q.x;
        quaternions[4*i + 1] = q.y;
        quaternions[4*i + 2] = q.z;
        quaternions[4*i + 3] = q.w;
    }
    
    // Send data back to the main thread
    self.postMessage({
        positions:positions,
        quaternions:quaternions
    }, [positions.buffer,
        quaternions.buffer]);
};
</script>


<script type="text/javascript" src="index.js"></script>
</body>
</html>
