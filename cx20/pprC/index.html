<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>立体的なドット絵を崩壊させてみるテスト - js do it</title>
<meta name="Description" content="" />
<meta name="Keywords"  content="" />

<link rel="stylesheet" type="text/css" media="screen,print" href="style.css" />
</head>
<body>
<!-- generated by: jsdo.it - http://jsdo.it/cx20/pprC -->
<!-- Copyright cx20 - http://jsdo.it/cx20 -->
<!-- Licensed under MIT License - http://www.opensource.org/licenses/mit-license.php -->

<!-- three.min.js -->
<script src="https://rawcdn.githack.com/mrdoob/three.js/r62/build/three.js"></script>
<script src="ExplodeModifier.js"></script>

<script type="x-shader/x-vertex" id="vertexShader">
uniform float uTime; // 0 to 1

attribute vec4 aRotation; // xyz = axis, w = rotation(rad)
attribute vec3 aCentroid;
attribute vec3 aTranslation;
attribute vec3 aAnimation;

varying vec3 vNormal;
varying float vPercentage;

vec3 rotateVector(vec4 q, vec3 v)
{
    return v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);
}

vec4 quatFromAxisAngle(vec3 axis, float angle)
{
    float halfAngle = angle * 0.5;

    return vec4(axis.xyz * sin(halfAngle), cos(halfAngle));
}

void main()
{
    float duration = aAnimation.x;
    float delay = aAnimation.y;
    float tPercentage;

    if (uTime < delay) tPercentage = 0.0;
    else if (uTime <= delay + duration) tPercentage = (uTime - delay) / duration;
    else tPercentage = 1.0;

    vec3 tPosition;
    tPosition = position - aCentroid;
    tPosition = rotateVector(quatFromAxisAngle(aRotation.xyz, aRotation.w * tPercentage), tPosition);
    tPosition = tPosition + aCentroid;
    tPosition = tPosition + aTranslation * tPercentage;

    vNormal = normal;
    vPercentage = tPercentage;

    gl_Position = projectionMatrix * modelViewMatrix * vec4(tPosition, 1.0);
}
</script>

<script type="x-shader/x-fragment" id="fragmentShader">
const vec3 cDirLight = vec3(1.0, 0.0, 0.0);
const vec3 cFrontColor = vec3(1.0, 1.0, 1.0);
const vec3 cBackColor = vec3(1.0, 0.0, 1.0);

varying vec3 vNormal;
varying float vPercentage;

void main()
{
    float tDot;
    vec3 tFaceColor;
    vec3 tFragColor;

    if (gl_FrontFacing)
    {
        tDot = max(0.0, dot(vNormal, cDirLight));
        tFaceColor = cFrontColor;
        tFragColor = tFaceColor * tDot;
    }
    else
    {
        tFragColor = abs(vNormal);
    }

    gl_FragColor = vec4(tFragColor, 1.0 - vPercentage);  
}
</script>

<div id="container"></div>


<script type="text/javascript" src="index.js"></script>
</body>
</html>
